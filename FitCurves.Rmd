---
title: "Fit Curves"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

# Merge datasets for all waves

# in wave 2, sessions 6 and 12 the button boxes was different for the controls
CHeck diffs wave 2 and rest, controls experimental in wave 2

```{r, warning = F}
library(rstan)
library(chron)
library(dplyr)
library(ggplot2)

options(mc.cores = parallel::detectCores())

theme_lh = function () { 
    theme_bw(base_size=20, base_family="Avenir")
}
WD = "~/Software/LeftHand/fitcurves"
DATADIR = file.path(WD, "./data/")
setwd(WD)
MINTRIALS = 10

markoutliers = function(x) { ifelse(abs(x - mean(x)) > 3*sd(x), NA, x) }

trials.table = read.table("./data/complete_trials_table.csv", header = T, sep = ";")

unpaced_trials = subset(trials.table, paced == 0 & trial_type != "missed")
paced_trials = subset(trials.table, paced == 1 & trial_type != "missed")

# signal trials that follow an error, do not consider missing data
cumulative_diff = c(0, diff(unpaced_trials$cumulative_trial))
true_sequence_diff = c(0, diff(as.numeric(unpaced_trials$true_sequence)))
username_diff = c(0, diff(as.numeric(unpaced_trials$username)))

posterror = c(0, unpaced_trials$accuracy[-nrow(unpaced_trials)] < 1)
unpaced_trials$posterror = (true_sequence_diff == 0 & username_diff == 0 & cumulative_diff == 1 & posterror)*1

# circadian patterns
unpaced_trials = unpaced_trials %>% mutate(sess_time_sin = sin(2*pi*as.numeric(times(sess_time))),
sess_time_cos = cos(2*pi*as.numeric(times(sess_time))))

# calculate training in days
unpaced_trials$sess_day=0
unpaced_trials$cum_day=0
unpaced_trials$sess_day_diff=0

mysubjects = unique(unpaced_trials$username)
for (name in mysubjects){
unpaced_trials$sess_day[unpaced_trials$username == name] = round(difftime(unpaced_trials$sess_date[unpaced_trials$username == name], unpaced_trials$sess_date[unpaced_trials$username == name][1], units = "days"))
mydays = unique(unpaced_trials$sess_day[unpaced_trials$username == name])
mydiff = c(0, diff(mydays))
cum_day = seq(length(unique(mydays)))
names(mydiff) = names(cum_day) = mydays
unpaced_trials$cum_day[unpaced_trials$username == name] = cum_day[as.character(unpaced_trials$sess_day[unpaced_trials$username == name])]
unpaced_trials$sess_day_diff[unpaced_trials$username == name] = mydiff[as.character(unpaced_trials$sess_day[unpaced_trials$username == name])]
}

#View(unpaced_trials[c("username", "true_sequence", "cumulative_trial", "accuracy","posterror")])

ok_unpaced_trials = subset(unpaced_trials, accuracy == 1)
ok_unpaced_trials.clean = ok_unpaced_trials %>% group_by(username, sess_num, true_sequence) %>% mutate(MT = markoutliers(MT))
ok_paced_trials = subset(paced_trials, accuracy == 1)

#subject_data = read.csv("C:/Users/benjamin.garzon/Google Drive/MyPapers/LeftHand/Experiment2/Randomization/SubjectData.csv")

```


# session variables

# subjects variables
Prepare data

```{r fig.width=25, fig.asp=0.4, warning= F}

# second process controlling a and b
# loo
# add and compare with controls e. g. 10 and 10
# check what happens with sess_day float?
# identify which parameters vary meaningfully
# study pairs plot
# different noise for different people

# get principal factor
# add and compare with controls

# unfold trials and put wrong trials
# predict unseen session, preditct untrained
# errors are normal?

# calculate the number of sequences automatically (not 3) xxx
# add coffee etc covariates, time of day -- xxx
# test time of day xxxx
# sequences as group levels - make it hierarchical xxxx
# posterrors xxx
# consolidation and sleep xxx 
# unfold sequences xxx
# three-compartment model xxx
# what percentage of the variance am I explaining? xxx
if(F){
mytrials = subset(ok_unpaced_trials.clean, username %in% c("lue1103", "lue1104", "lue1105", "lue2105", "lue1107",  "lue2101", "lue2103", "lue3101", "lue3102", "lue5101") & seq_train == "trained" & sess_num < 25) %>% filter(!is.na(MT))  
mytrials = subset(ok_unpaced_trials.clean, username %in% c( "lue1107",  "lue2101", "lue2103", "lue3101", "lue3102", "lue5101") & seq_train == "trained" & sess_num < 15) %>% filter(!is.na(MT))  

} else {
#mytrials = subset(ok_unpaced_trials.clean, group == "Experimental" & seq_train == "trained") %>% filter(!is.na(MT))
  
# lue1201 did the wrong first sessions an messes up the estimates
mytrials = subset(ok_unpaced_trials.clean, username != "lue1201" & seq_train == "trained" ) %>% filter(!is.na(MT)) 
#  %>% group_by(username, trial, sess_day) %>% summarise(MT = median(MT, na.rm = T), RT = median(RT, 
}
mytrials = mytrials %>% arrange(username, sess_day, true_sequence, trial)

mytrials$username = factor(mytrials$username)
mytrials$true_sequence = factor(mytrials$true_sequence)

plot.MT = ggplot(mytrials, aes(x = sess_day, y = MT, group = username, col = trial)) + geom_line(size = 1) + geom_point(size = 2) + theme_lh() + xlab('Session') + ylab('Movement duration (ms)')  #+ facet_grid(username ~ . )
print(plot.MT)

plot.MT = ggplot(mytrials, aes(x = trial, y = MT, group = sess_num, col = sess_num)) + geom_point(size = 0.1) + geom_line() + theme_lh() + xlab('Trial') + ylab('Movement duration (ms)')  + facet_grid(true_sequence ~username )
print(plot.MT)


####### 
# lue1201 did the wrong sequencs in the first session
#mytrials = subset(mytrials, !(username == "lue1201" & sess_num == 0))
#plot.MT = ggplot(subset(mytrials, username == "lue1201"), aes(x = sess_day, y = MT, group = username, col = trial)) + geom_line(size = 1) + geom_point(size = 2) + theme_lh() + xlab('Session') + ylab('Movement duration (ms)')  + facet_grid(true_sequence ~ .  )
#print(plot.MT)
#######

#mytrials$cluster = as.numeric(as.factor(paste(mytrials$username, format(mytrials$sess_day, width = 2, flag = "0") )))
  mytrials$cluster = as.numeric(as.factor(paste(mytrials$username, format(mytrials$sess_day, width = 2, flag = "0"), mytrials$true_sequence) ))
mysubjects = levels(mytrials$username)

myclusters = unique(mytrials[c("username", "sess_day", "cum_day", "true_sequence")])
mysessions = unique(mytrials[c("username", "sess_day", "cum_day")])

View(myclusters) # %>% arrange(username, sess_day))

mycovars = c("posterror", "physical_activity", "sleep", "cigarettes",  "liquid", "coffee", "alcohol")
mycovarsf = c("sess_time_cos", "sess_time_sin")
time_mat = matrix(0, length(mysubjects), max(myclusters$cum_day))

# how many sifferent sequences per subject?
Ndiffseqvec = NULL
for (s in mysubjects){
  aux = subset(myclusters, username == s)
  Ndiffseqvec[s] = length(unique(aux$true_sequence))
}
Ndiffseq = max(Ndiffseqvec) #only trained

Nseq = max(as.integer(mytrials$true_sequence))
seq_mat = matrix(0, length(mysubjects), Ndiffseq)

for (i in 1:length(mysubjects)){
  s = levels(mysessions$username)[i]
  for (j in mysessions$cum_day[mysessions$username == s]){
        time_mat[i, j] = mysessions$sess_day[mysessions$username == s][j]
  }
  seq_mat[i, ] = unique(myclusters$true_sequence[myclusters$username == s])

  }

# seq_mat  and time_mat in the same order as mysubjects!

stan_data = list(cluster = mytrials$cluster, 
                 trial = mytrials$trial, 
                 y = mytrials$MT, 
                 Nclus = max(mytrials$cluster), 
                 Nsub = length(mysubjects),
                 Nseq = Nseq,
                 Ndiffseq = Ndiffseq,
                 subject = as.integer(myclusters$username),
                 day = as.integer(myclusters$sess_day), 
                 cum_day = as.integer(myclusters$cum_day), 
                 max_cum_day = max(as.integer(myclusters$cum_day)), 
                 time_mat = time_mat, 
                 seq_mat = seq_mat,
                 sequence = as.integer(mytrials$true_sequence), 
                 N = nrow(mytrials), 
                 z = mytrials[mycovars],
                 zf = mytrials[mycovarsf],
                 Ncovars = length(mycovars),
                 Ncovarsf = length(mycovarsf)
                 )
```
#Three -compartment model

There is a post-error slowing effect ~ 100 ms
There is an effect of time of the day ~ 60 ms

Retention factor  .2 -.9

```{r fig.width=25, fig.asp=0.4, warning= F}

#stan_control = list(adapt_delta = 0.85, max_treedepth = 13)
stan_control = list(adapt_delta = 0.85, max_treedepth = 12)
ITER = 20000
WARMUP = 19000

stan_init = function() {list(mu_hyp_asub = c(3, -1, -3, 0, 0, 0), #rep(0, 6), 
                             mu_hyp_bsub = array(0.3, 1), 
                             mu_hyp_csub = rep(0, 6),
                             sigma_hyp_asub = rep(1, 6),
                             sigma_hyp_bsub = array(0.3, 1),
                             sigma_hyp_csub = rep(1, 6),
                             sigma = 200,
                             mu_hyp_seq = rep(-1500, 6),
                             sigma_hyp_seq = rep(100, 6),
                             mu_hyp_beta = rep(0, 7),
                             sigma_hyp_beta = rep(50, 7))}
  
if (T){
fit.1 = stan(file = "learning_model_double3comp_HR.stan", chains = 4, iter = ITER, warmup = WARMUP, data = stan_data, control = stan_control, init = stan_init)
} else {
fit.1 = vb(stan_model(file = "learning_model_double3comp_HR.stan"), iter = ITER, data = stan_data, init = stan_init)
}

# check chains
traceplot(fit.1, par = c('mu_hyp_asub', 'sigma_hyp_asub', 'mu_hyp_bsub', 'sigma_hyp_bsub', 'mu_hyp_csub', 'sigma_hyp_csub','sigma', 'mu_hyp_beta', 'sigma_hyp_beta', 'mu_hyp_seq', 'sigma_hyp_seq'), inc_warmup = T)
traceplot(fit.1, par = c('mu_hyp_asub', 'mu_hyp_bsub', 'mu_hyp_csub', 'sigma_hyp_asub', 'sigma_hyp_bsub', 'sigma_hyp_csub', 'sigma'))
plot(fit.1, par = c('mu_hyp_asub',  'sigma_hyp_asub', 'sigma'))
plot(fit.1, par = c('mu_hyp_bsub', 'mu_hyp_csub', 'sigma_hyp_bsub', 'sigma_hyp_csub'))
plot(fit.1, par = c('mu_hyp_seq',  'sigma_hyp_seq'))
pairs(fit.1, pars = c('mu_hyp_asub[1]', 'mu_hyp_csub[1]', 'mu_hyp_csub[3]', 
                      'sigma_hyp_asub[1]', 'sigma_hyp_csub[1]', 'sigma_hyp_csub[3]'))
pairs(fit.1, pars = c('mu_hyp_asub', 'mu_hyp_bsub', 'mu_hyp_csub', 'sigma_hyp_asub', 'sigma_hyp_bsub', 'sigma_hyp_csub'))
#check parameters
plot(fit.1, par = c('r0_a'))
plot(fit.1, par = c('e0_a'))
plot(fit.1, par = c('p0_a'))
plot(fit.1, par = c('kr_a'))
plot(fit.1, par = c('ke_a'))
plot(fit.1, par = c('kp_a'))

plot(fit.1, par = paste0('csub[', seq(stan_data$Nsub), ',1]'))
plot(fit.1, par = paste0('csub[', seq(stan_data$Nsub), ',2]'))
plot(fit.1, par = paste0('csub[', seq(stan_data$Nsub), ',3]'))
plot(fit.1, par = paste0('csub[', seq(stan_data$Nsub), ',4]'))

params = summary(fit.1)$summary[, "mean"]
rhat = summary(fit.1)$summary[, "Rhat"]
neff = summary(fit.1)$summary[, "n_eff"]
# a = params[grep("\\ba\\[", names(params))]
# b = params[grep("\\bb\\[", names(params))]
# c = params[grep("\\bc\\[", names(params))]

r0_a = params[grep("\\br0_a\\[", names(params))]
e0_a = params[grep("\\be0_a\\[", names(params))]
p0_a = params[grep("\\bp0_a\\[", names(params))]
kr_a = params[grep("\\bkr_a\\[", names(params))]
ke_a = params[grep("\\bke_a\\[", names(params))]
kp_a = params[grep("\\bkp_a\\[", names(params))]

r0_c = params[grep("\\br0_c\\[", names(params))]
e0_c = params[grep("\\be0_c\\[", names(params))]
p0_c = params[grep("\\bp0_c\\[", names(params))]
kr_c = params[grep("\\bkr_c\\[", names(params))]
ke_c = params[grep("\\bke_c\\[", names(params))]
kp_c = params[grep("\\bkp_c\\[", names(params))]

r0_a_mean = params[grep("r0_a_mean", names(params))]
e0_a_mean = params[grep("e0_a_mean", names(params))]
p0_a_mean = params[grep("p0_a_mean", names(params))]
kr_a_mean = params[grep("kr_a_mean", names(params))]
ke_a_mean = params[grep("ke_a_mean", names(params))]
kp_a_mean = params[grep("kp_a_mean", names(params))]

r0_c_mean = params[grep("r0_c_mean", names(params))]
e0_c_mean = params[grep("e0_c_mean", names(params))]
p0_c_mean = params[grep("p0_c_mean", names(params))]
kr_c_mean = params[grep("kr_c_mean", names(params))]
ke_c_mean = params[grep("ke_c_mean", names(params))]
kp_c_mean = params[grep("kp_c_mean", names(params))]

asub = matrix(params[grep("\\basub\\[", names(params))], , 6, byrow = T)
bsub = params[grep("\\bbsub\\[", names(params))]
csub = matrix(params[grep("\\bcsub\\[", names(params))], , 6, byrow = T)

subparams = as.data.frame(cbind(asub, bsub, csub))
colnames(subparams) = c("asub1", "asub2", "asub3", "asub4", "asub5", "asub6", "bsub1", "csub1", "csub2", "csub3", "csub4", "csub5", "csub6")
  rownames(subparams) = seq(nrow(subparams))
cor(subparams)
beta_all = params[grep("\\bbeta\\[", names(params))]
beta = matrix(beta_all, , stan_data$Ncovars)
colnames(beta) = mycovars
#beta.samples = rstan::extract(fit.1, par = "beta")$beta
betaf_all = params[grep("betaf\\[", names(params))]
betaf = matrix(betaf_all, , stan_data$Ncovarsf)
colnames(betaf) = mycovarsf
betaf.samples = rstan::extract(fit.1, par = "betaf")$betaf

plot(betaf[,1], betaf[,2], pch = 20)
time_effect = apply(betaf.samples, c(1, 3), function(x) sqrt(sum(x^2)))

y_new = params[grep("y_new\\[", names(params))]

results = mytrials[c("username", "sess_day", "trial", "MT", "true_sequence")] %>% group_by(username, true_sequence) %>% mutate(ind = row_number())
results$MT.pred = y_new

plot(results$MT, results$MT.pred, pch = 20, xlab = "Measured MT (ms)", ylab = "Predicted MT (ms)", cex = 0.1)
abline(0, 1)

# explained variance
exp.var = 1 - var(results$MT - results$MT.pred)/var(results$MT)


myplot = ggplot(results, aes(x = trial, y = MT, col = true_sequence)) + geom_point(size = 0.2) + geom_line(aes(x = trial, y = MT.pred, group = true_sequence, col = true_sequence), size = 0.9) + theme_classic() + facet_grid(username ~ sess_day)
print(myplot)

myplot = ggplot(results, aes(x = ind, y = MT, col = as.factor(sess_day))) + geom_point(size = 0.2) + geom_line(aes(x = ind, y = MT.pred, group = as.factor(sess_day)), col = "black" ) + theme_classic() + facet_grid(username ~ true_sequence)
print(myplot)

results.mean = results %>% group_by(username, sess_day, trial) %>% summarise(MT.pred = mean(MT.pred), MT = mean(MT))
myplot = ggplot(results.mean, aes(x = trial, y = MT, col = username)) + geom_line(size = 0.2) + geom_line(aes(x = trial, y = MT.pred, group = username, col = username), size = 0.7) + theme_classic() + facet_grid(. ~ sess_day)
print(myplot)

#myplot = ggplot(results, aes(x = trial, y = MT, col = true_sequence)) + geom_point() + geom_line(aes(x = trial, y = MT.pred, group = true_sequence, col = true_sequence)) + theme_classic() + facet_grid(sess_day ~ username )
#print(myplot)

# sequence difficulty differences


# which parameters vary meaningfully by comparing parameter uncertainty with variability across subjects
asub.samp = rstan::extract(fit.1, par = "asub")$asub
bsub.samp = rstan::extract(fit.1, par = "bsub")$bsub
csub.samp = rstan::extract(fit.1, par = "csub")$csub

asub.wt = colMeans(apply(asub.samp, c(2, 3), sd))
asub.bt = apply(apply(asub.samp, c(2, 3), mean), 2, sd)
csub.wt = colMeans(apply(csub.samp, c(2, 3), sd))
csub.bt = apply(apply(csub.samp, c(2, 3), mean), 2, sd)
asub.bt/asub.wt
csub.bt/csub.wt

# sequence differences



# save results
saveRDS(fit.1, file = file.path(WD, "./results/", paste0("fit-", format(Sys.time(), "%d%m%y_%H%M"), ".rds")))


library(shinystan)
launch_shinystan(fit.1)
stophere

```

#Characterize results
```{r}

```

```{r fig.width=25, fig.asp=0.4, warning= F}

#stan_control = list(adapt_delta = 0.85, max_treedepth = 13)
stan_control = list(adapt_delta = 0.8, max_treedepth = 12)
ITER = 1500
WARMUP = 1000

stan_init = function() {list(mu_hyp_asub = array(300, 1), 
                             mu_hyp_bsub = array(0.3, 1), 
                             mu_hyp_csub = rep(0, 6),
                             sigma_hyp_asub = array(100, 1),
                             sigma_hyp_bsub = array(0.3, 1),
                             sigma_hyp_csub = rep(1, 6),
                             sigma = 200,
                             mu_hyp_seq = rep(0, 6),
                             sigma_hyp_seq = rep(100, 6),
                             mu_hyp_beta = rep(300, 7),
                             sigma_hyp_beta = rep(300, 7))}
  
if (T){
fit.1 = stan(file = "learning_model_single3comp_HR.stan", chains = 4, iter = ITER, warmup = WARMUP, data = stan_data, control = stan_control, init = stan_init)
} else {
fit.1 = vb(stan_model(file = "learning_model_single3comp_HR.stan"), iter = ITER, data = stan_data, init = stan_init)
}

# check chains
traceplot(fit.1, par = c('mu_hyp_asub', 'sigma_hyp_asub', 'mu_hyp_bsub', 'sigma_hyp_bsub', 'mu_hyp_csub', 'sigma_hyp_csub','sigma', 'mu_hyp_beta', 'sigma_hyp_beta', 'mu_hyp_seq', 'sigma_hyp_seq'), inc_warmup = F)
traceplot(fit.1, par = c('mu_hyp_asub', 'mu_hyp_bsub', 'mu_hyp_csub', 'sigma_hyp_asub', 'sigma_hyp_bsub', 'sigma_hyp_csub', 'sigma'))
plot(fit.1, par = c('mu_hyp_asub',  'sigma_hyp_asub', 'sigma'))
plot(fit.1, par = c('mu_hyp_bsub', 'mu_hyp_csub', 'sigma_hyp_bsub', 'sigma_hyp_csub'))
plot(fit.1, par = c('mu_hyp_seq',  'sigma_hyp_seq'))
pairs(fit.1, pars = c('mu_hyp_asub[1]', 'mu_hyp_csub[1]', 'mu_hyp_csub[3]', 
                      'sigma_hyp_asub[1]', 'sigma_hyp_csub[1]', 'sigma_hyp_csub[3]'))

#check parameters
plot(fit.1, par = c('r0'))
plot(fit.1, par = c('e0'))
plot(fit.1, par = c('p0'))
plot(fit.1, par = c('kr'))
plot(fit.1, par = c('ke'))
plot(fit.1, par = c('kp'))

plot(fit.1, par = paste0('csub[', seq(stan_data$Nsub), ',1]'))
plot(fit.1, par = paste0('csub[', seq(stan_data$Nsub), ',2]'))
plot(fit.1, par = paste0('csub[', seq(stan_data$Nsub), ',3]'))
plot(fit.1, par = paste0('csub[', seq(stan_data$Nsub), ',4]'))

params = summary(fit.1)$summary[, "mean"]
rhat = summary(fit.1)$summary[, "Rhat"]
neff = summary(fit.1)$summary[, "n_eff"]
# a = params[grep("\\ba\\[", names(params))]
# b = params[grep("\\bb\\[", names(params))]
# c = params[grep("\\bc\\[", names(params))]

r0 = params[grep("\\br0\\[", names(params))]
e0 = params[grep("\\be0\\[", names(params))]
p0 = params[grep("\\bp0\\[", names(params))]
kr = params[grep("\\bkr\\[", names(params))]
ke = params[grep("\\bke\\[", names(params))]
kp = params[grep("\\bkp\\[", names(params))]

r0_mean = params[grep("r0_mean", names(params))]
e0_mean = params[grep("e0_mean", names(params))]
p0_mean = params[grep("p0_mean", names(params))]
kr_mean = params[grep("kr_mean", names(params))]
ke_mean = params[grep("ke_mean", names(params))]
kp_mean = params[grep("kp_mean", names(params))]

asub = matrix(params[grep("\\basub\\[", names(params))], , 1, byrow = T)
bsub = params[grep("\\bbsub\\[", names(params))]
csub = matrix(params[grep("\\bcsub\\[", names(params))], , 6, byrow = T)

subparams = as.data.frame(cbind(asub, bsub, csub))
colnames(subparams) = c("asub1", "bsub2", "csub1", "csub2", "csub3", "csub4", "csub5", "csub6")
rownames(subparams) = seq(nrow(subparams))
cor(subparams)
beta_all = params[grep("\\bbeta\\[", names(params))]
beta = matrix(beta_all, , stan_data$Ncovars)
colnames(beta) = mycovars
#beta.samples = rstan::extract(fit.1, par = "beta")$beta
betaf_all = params[grep("betaf\\[", names(params))]
betaf = matrix(betaf_all, , stan_data$Ncovarsf)
colnames(betaf) = mycovarsf
betaf.samples = rstan::extract(fit.1, par = "betaf")$betaf

plot(betaf[,1], betaf[,2], pch = 20)
time_effect = apply(betaf.samples, c(1, 3), function(x) sqrt(sum(x^2)))

y_new = params[grep("y_new\\[", names(params))]

results = mytrials[c("username", "sess_day", "trial", "MT", "true_sequence")] %>% group_by(username, true_sequence) %>% mutate(ind = row_number())
results$MT.pred = y_new

plot(results$MT, results$MT.pred, pch = 20, xlab = "Measured MT (ms)", ylab = "Predicted MT (ms)", cex = 0.1)
abline(0, 1)

# explained variance
exp.var = 1 - var(results$MT - results$MT.pred)/var(results$MT)


myplot = ggplot(results, aes(x = trial, y = MT, col = true_sequence)) + geom_point(size = 0.2) + geom_line(aes(x = trial, y = MT.pred, group = true_sequence, col = true_sequence), size = 0.9) + theme_classic() + facet_grid(username ~ sess_day)
print(myplot)

myplot = ggplot(results, aes(x = ind, y = MT, col = as.factor(sess_day))) + geom_point(size = 0.2) + geom_line(aes(x = ind, y = MT.pred, group = as.factor(sess_day)), col = "black" ) + theme_classic() + facet_grid(username ~ true_sequence)
print(myplot)

results.mean = results %>% group_by(username, sess_day, trial) %>% summarise(MT.pred = mean(MT.pred), MT = mean(MT))
myplot = ggplot(results.mean, aes(x = trial, y = MT, col = username)) + geom_line(size = 0.2) + geom_line(aes(x = trial, y = MT.pred, group = username, col = username), size = 0.7) + theme_classic() + facet_grid(. ~ sess_day)
print(myplot)

#myplot = ggplot(results, aes(x = trial, y = MT, col = true_sequence)) + geom_point() + geom_line(aes(x = trial, y = MT.pred, group = true_sequence, col = true_sequence)) + theme_classic() + facet_grid(sess_day ~ username )
#print(myplot)

# sequence difficulty differences


# which parameters vary meaningfully by comparing parameter uncertainty with variability across subjects
asub.samp = rstan::extract(fit.1, par = "asub")$asub
bsub.samp = rstan::extract(fit.1, par = "bsub")$bsub
csub.samp = rstan::extract(fit.1, par = "csub")$csub

asub.wt = colMeans(apply(asub.samp, c(2, 3), sd))
asub.bt = apply(apply(asub.samp, c(2, 3), mean), 2, sd)
csub.wt = colMeans(apply(csub.samp, c(2, 3), sd))
csub.bt = apply(apply(csub.samp, c(2, 3), mean), 2, sd)
asub.bt/asub.wt
csub.bt/csub.wt

# sequence differences

library(shinystan)
launch_shinystan(fit.1)
stophere

```

Two-compartment model

```{r fig.width=25, fig.asp=0.4, warning= F}

stan_control = list(adapt_delta = 0.8, max_treedepth = 12)
ITER = 2000
WARMUP = 1500

stan_init = function() {list(mu_hyp_asub = array(1000, 1), 
                             mu_hyp_bsub = array(0.3, 1), 
                             mu_hyp_csub = c(1.3, -0.8, -2.2, -1.5),
                             sigma_hyp_asub = array(1000, 1),
                             sigma_hyp_bsub = array(0.3, 1),
                             sigma_hyp_csub = c(1.6, 0.3, 0.4, 1.2),
                             sigma = 200,
                             mu_hyp_seq = rep(0, 6),
                             sigma_hyp_seq = rep(100, 6))}


  
if (T){
fit.1 = stan(file = "learning_model_single2comp_HR.stan", chains = 4, iter = ITER, warmup = WARMUP, data = stan_data, control = stan_control, init = stan_init)
} else {
fit.1 = vb(stan_model(file = "learning_model_single2comp_HR.stan"), iter = ITER, data = stan_data, init = stan_init)
}

traceplot(fit.1, par = c('mu_hyp_asub', 'sigma_hyp_asub', 'mu_hyp_bsub', 'sigma_hyp_bsub', 'mu_hyp_csub', 'sigma_hyp_csub','sigma', 'mu_hyp_beta', 'sigma_hyp_beta', 'mu_hyp_seq', 'sigma_hyp_seq'), inc_warmup = F)
traceplot(fit.1, par = c('mu_hyp_asub', 'mu_hyp_bsub', 'mu_hyp_csub', 'sigma_hyp_asub', 'sigma_hyp_bsub', 'sigma_hyp_csub', 'sigma'))
plot(fit.1, par = c('mu_hyp_asub',  'sigma_hyp_asub', 'sigma'))
plot(fit.1, par = c('mu_hyp_bsub', 'mu_hyp_csub', 'sigma_hyp_bsub', 'sigma_hyp_csub'))
plot(fit.1, par = c('mu_hyp_seq',  'sigma_hyp_seq'))
pairs(fit.1, pars = c('mu_hyp_asub[1]', 'mu_hyp_csub[1]', 'mu_hyp_csub[3]', 
                      'sigma_hyp_asub[1]', 'sigma_hyp_csub[1]', 'sigma_hyp_csub[3]'))

plot(fit.1, par = c('r0'))
plot(fit.1, par = c('c0'))
plot(fit.1, par = c('kr'))
plot(fit.1, par = c('kc'))

plot(fit.1, par = paste0('csub[', seq(stan_data$Nsub), ',1]'))
plot(fit.1, par = paste0('csub[', seq(stan_data$Nsub), ',2]'))
plot(fit.1, par = paste0('csub[', seq(stan_data$Nsub), ',3]'))
plot(fit.1, par = paste0('csub[', seq(stan_data$Nsub), ',4]'))

params = summary(fit.1)$summary[, "mean"]
rhat = summary(fit.1)$summary[, "Rhat"]
neff = summary(fit.1)$summary[, "n_eff"]
# a = params[grep("\\ba\\[", names(params))]
# b = params[grep("\\bb\\[", names(params))]
# c = params[grep("\\bc\\[", names(params))]

r0 = params[grep("\\br0\\[", names(params))]
c0 = params[grep("\\bc0\\[", names(params))]
kr = params[grep("\\bkr\\[", names(params))]
kc = params[grep("\\bkc\\[", names(params))]

asub = matrix(params[grep("\\basub\\[", names(params))], , 1, byrow = T)
bsub = params[grep("\\bbsub\\[", names(params))]
csub = matrix(params[grep("\\bcsub\\[", names(params))], , 4, byrow = T)

subparams = as.data.frame(cbind(asub, bsub, csub))
colnames(subparams) = c("asub1", "bsub2", "csub1", "csub2", "csub3", "csub4")
rownames(subparams) = seq(nrow(subparams))
cor(subparams)
#beta_all = params[grep("beta\\[", names(params))]
#beta = t(matrix(beta_all, , stan_data$Ncovars))
#beta.samples = rstan::extract(fit.1, par = "beta")$beta
y_new = params[grep("y_new\\[", names(params))]

# explained variance

results = mytrials[c("username", "sess_day", "trial", "MT", "true_sequence")] %>% group_by(username, true_sequence) %>% mutate(ind = row_number())
results$MT.pred = y_new

exp.var = 1 - var(results$MT - results$MT.pred)/var(results$MT)

myplot = ggplot(results, aes(x = trial, y = MT, col = true_sequence)) + geom_point(size = 0.2) + geom_line(aes(x = trial, y = MT.pred, group = true_sequence, col = true_sequence), size = 0.9) + theme_classic() + facet_grid(username ~ sess_day)
print(myplot)

myplot = ggplot(results, aes(x = ind, y = MT, col = as.factor(sess_day))) + geom_point(size = 0.2) + geom_line(aes(x = ind, y = MT.pred, group = as.factor(sess_day)), col = "black" ) + theme_classic() + facet_grid(username ~ true_sequence)
print(myplot)

results.mean = results %>% group_by(username, sess_day, trial) %>% summarise(MT.pred = mean(MT.pred), MT = mean(MT))
myplot = ggplot(results.mean, aes(x = trial, y = MT, col = username)) + geom_line(size = 0.2) + geom_line(aes(x = trial, y = MT.pred, group = username, col = username), size = 0.7) + theme_classic() + facet_grid(. ~ sess_day)
print(myplot)

#myplot = ggplot(results, aes(x = trial, y = MT, col = true_sequence)) + geom_point() + geom_line(aes(x = trial, y = MT.pred, group = true_sequence, col = true_sequence)) + theme_classic() + facet_grid(sess_day ~ username )
#print(myplot)


# which parameters vary meaningfully by comparing parameter uncertainty with variability across subjects
asub.samp = rstan::extract(fit.1, par = "asub")$asub
bsub.samp = rstan::extract(fit.1, par = "bsub")$bsub
csub.samp = rstan::extract(fit.1, par = "csub")$csub

asub.wt = colMeans(apply(asub.samp, c(2, 3), sd))
asub.bt = apply(apply(asub.samp, c(2, 3), mean), 2, sd)
csub.wt = colMeans(apply(csub.samp, c(2, 3), sd))
csub.bt = apply(apply(csub.samp, c(2, 3), mean), 2, sd)
asub.bt/asub.wt
csub.bt/csub.wt

# sequence differences

library(shinystan)
launch_shinystan(fit.1)

# posterror slowing
p = beta[2, ]
plot(p[unique(subset(mytrials, username == "lue1103")$cluster)], type = "l", ylim = c(-300, 300))
lines(p[unique(subset(mytrials, username == "lue1105")$cluster)], type = "l")
lines(p[unique(subset(mytrials, username == "lue2103")$cluster)], type = "l")

results = mytrials
results = results %>% group_by(username, sess_day, true_sequence, seq_train) %>% summarise(n = n())
results$posterror = p
results.mean = results %>% group_by(sess_day, seq_train) %>% summarise(posterror = mean(posterror, na.rm = T))
myplot = ggplot(results.mean, aes(x = sess_day, y = posterror)) + geom_line() + theme_classic() + facet_grid(. ~ seq_train )
print(myplot)
```

```{r}

```



```{r, warnings = F}
stophere 

last_trials.all = subset(ok_unpaced_trials.clean, group == "Experimental" & trial > MINTRIALS & seq_train == "trained")  %>% 
  group_by(sess_num) %>% 
  dplyr::summarise(medianMT = median(MT, na.rm = T))

# last_trials.user = subset(ok_unpaced_trials.clean, group == "Experimental" & trial > MINTRIALS) %>% 
#   group_by(username, sess_num, followup, wave) %>% 
#   dplyr::summarise(meanMT = mean(MT, na.rm = T), sdMT = sd(MT, na.rm = T))

#plot.meanMT = ggplot(last_trials.all, aes(x = sess_num, y = medianMT)) + geom_line(size = 2) + geom_point(size = 3) + theme_lh() + xlab('Session') + ylab('Movement duration (ms)') 
#print(plot.meanMT)

stan_control = list(adapt_delta = 0.9, max_treedepth = 12)
ITER = 3000
WARMUP = 2500

last_trials.all$cluster = 1
# fit with stan
stan_data = list(cluster = last_trials.all$cluster, x = last_trials.all$sess_num, y = last_trials.all$medianMT, 
                 Nclus = max(last_trials.all$cluster), N = nrow(last_trials.all) )

#fit = stan(file = "exponential_fit.stan", chains = 4, iter = 5000, warmup = 400, data = stan_data,
fit.1 = stan(file = "learning_model_single1.stan", chains = 4, iter = ITER, warmup = WARMUP, data = stan_data, control = stan_control)

params = summary(fit.1)$summary[, "mean"]
a1 = params[grep("a1\\[", names(params))]
b1 = params[grep("b1\\[", names(params))]
c = params[grep("c\\[", names(params))]
y_new = params[grep("y_new\\[", names(params))]


```

#Post-error slowing
#```{r}
#for ( i)
#```

Reaction time and movement times
```{r}

```


```{r}

# actual date since start
# time of the day
#difference in hours
# check how you get the first day

ok_trials = subset(trials.table, accuracy == 1 &  paced == 0 & trial_type != 'missed' ) %>% mutate(sess_time_sin = sin(2*pi*as.numeric(times(sess_time))),
sess_time_cos = cos(2*pi*as.numeric(times(sess_time))))
ok_trials$sess_day=0
ok_trials$sess_day_diff=0

mysubjects = unique(ok_trials$username)

# calculate training in days
for (name in mysubjects){
ok_trials$sess_day[ok_trials$username == name] = difftime(ok_trials$sess_date[ok_trials$username == name], ok_trials$sess_date[ok_trials$username == name][1], units = "days")
mydays = unique(ok_trials$sess_day[ok_trials$username == name])
mydiff = c(0, diff(mydays))
names(mydiff) = mydays
ok_trials$sess_day_diff[ok_trials$username == name] = mydiff[as.character(ok_trials$sess_day[ok_trials$username == name])]
}
ok_trials = subset(ok_trials, group %in% 'Experimental')

## learning : add & username %in% learners &

#ok_trials_learning = subset(ok_trials, trial > 10 & seq_train == 'trained') %>% group_by(username, true_sequence, sess_num) %>% summarise(medianMT = median(MT), sdMT = sd(MT))
ok_trials_learning = subset(ok_trials, trial > 10 & seq_train == 'trained') %>% group_by(username, sess_num, sess_time, sess_time_sin, sess_time_cos, sess_day, sess_day_diff) %>% summarise(medianMT = median(MT), sdMT = sd(MT), medianRT = median(RT)/1000)
ok_trials_learning$username = droplevels(ok_trials_learning$username)

ok_trials_learning$cluster = as.numeric(as.factor(paste(ok_trials_learning$true_sequence, ok_trials_learning$username)))
ok_trials_learning$cluster = as.numeric(as.factor(ok_trials_learning$username))
mysubjects = levels(as.factor(ok_trials_learning$username))

mycovars = c("sess_time_sin", "sess_time_cos", "sess_day_diff", "medianRT")
# fit with stan
stan_data = list(cluster = ok_trials_learning$cluster, x = ok_trials_learning$sess_day, y = ok_trials_learning$medianMT, 
                 Nclus = max(ok_trials_learning$cluster), 
                 N = nrow(ok_trials_learning),
                 z = ok_trials_learning[mycovars],
                 Ncovars = length(mycovars))


stan_control = list(adapt_delta = 0.9, max_treedepth = 12)
ITER = 2000
WARMUP = 1500

stan_init = function() {list(mu_hyp = c(800, .3, 1300), sigma_hyp = c(500, .2, 300))}

#fit = stan(file = "exponential_fit.stan", chains = 4, iter = 5000, warmup = 400, data = stan_data,
fit.1 = stan(file = "learning_model_single1_HR.stan", chains = 4, iter = ITER, warmup = WARMUP, data = stan_data, control = stan_control, init = stan_init)

plot(fit.1, par = c('a1'))
plot(fit.1, par = c('b1'))
plot(fit.1, par = c('c', 'sigma'))
plot(fit.1, par = c('beta'))

params = summary(fit.1)$summary[, "mean"]
a1 = params[grep("a1\\[", names(params))]
b1 = params[grep("b1\\[", names(params))]
c = params[grep("c\\[", names(params))]
beta_all = params[grep("beta\\[", names(params))]
beta = t(matrix(beta_all, , stan_data$Ncovars))
beta.samples = rstan::extract(fit.1, par = "beta")$beta
y_new = params[grep("y_new\\[", names(params))]

beta.means = apply(beta.samples, c(1, 2), mean)
hist(beta.means[, 3], 100)

hist(beta.means[, 1], 100)
hist(beta.means[, 2], 100)

xx = seq(0, 1, 0.05)
yy = beta.means[, 1]%*%t(as.matrix(sin(2*pi*xx))) + beta.means[, 2]%*%t(as.matrix(cos(2*pi*xx)))
matplot(xx*24, t(yy), pch = 20, type = "b", cex = 0.3)

plot(stan_data$y, pch = 20, type = "l")
lines(y_new, col = "red")

#plot(stan_data$x, stan_data$y, pch = 20)
#lines(stan_data$x, y_new, col = "red")

for(j in unique(stan_data$cluster)){
  
  par(mfrow = c(1, 2))
  y = stan_data$y[stan_data$cluster == j]
  x = stan_data$x[stan_data$cluster == j]
  z = stan_data$z[stan_data$cluster == j, ]
  tt = as.numeric(times(ok_trials_learning$sess_time[stan_data$cluster == j]))*24
  
  plot(x, y, pch = 20, main = mysubjects[j], type = "l", cex = .5, ylim = c(0, 3500))
  lines(x, a1[j]*exp(-b1[j]*x) + c[j], col = "red")
  lines(x, a1[j]*exp(-b1[j]*x) + as.matrix(z) %*% beta[, j ] + c[j], col = "red", lwd = 2)
  plot(tt, unlist(beta[1, j]*z[, 1] + beta[2, j]*z[, 2]), ylab = "MT", xlab = "Hour", type = "p", ylim = c(-200, 200), xlim = c(0, 24)) 
}

traceplot(fit.1, par = c('a1[1]', 'b1[1]', 'c[1]', 'sigma'))
traceplot(fit.1, par = c('mu_hyp', 'sigma_hyp'))

mypars = as.data.frame(cbind(a1, b1, c, beta[3, ]))

colnames(mypars) = c("a", "b", "c", "consol")

cor(mypars)
pairs(mypars)
pca = princomp(mypars, cor = T)
plot(pca)
plot(cumsum(pca$sdev*2)/sum(pca$sdev*2)*100)
print(pca$loadings)
mypars = mypars %>% mutate(improve = (c + a) / (c + a*exp(-b*36)))

components = as.data.frame(pca$scores)
components$StudyID = mysubjects
components = merge(components, subject_data, by = "StudyID")


plot(components$reasoning, components$Comp.2)
print(components %>% arrange(desc(Comp.2)))

print(head(mypars %>% arrange(desc(improve))) )

mypars$username = mysubjects
K = merge(sess.diff, mypars, by = "username")
cor.test(K$meanMT.diff, K$improve)
plot(K$meanMT.diff, K$improve)
text(K$meanMT.diff, K$improve, labels = as.character(K$username))
```

Prediction
Seeing the beginning how well can I predict the end?

```{r}

```

Compare to IQ
```{r}

summary(lm(mypars$consol ~ gender, data = components)) # guys are faster

summary(lm(Comp.1 ~ gender, data = components))
summary(lm(Comp.2 ~ gender, data = components))

summary(lm(reasoning ~ gender, data = components))

boxplot(Comp.1 ~ gender, data = components)
boxplot(Comp.2 ~ gender, data = components)

cor.test(components$reasoning, components$Comp.1)
cor.test(components$reasoning, components$Comp.2)

# try with all subjects, correlation between c and reasoning
# reasoning correlates with max value but not initial?

```


```{r}
stophere

#pairs(fit, pars = c('mu_hyp', 'sigma_hyp'))
#traceplot(fit, par = c('mu_hyp', 'sigma_hyp'))
#pairs(fit, par = 'mu_hyp')
fit.2 = stan(file = "learning_model_single2.stan", chains = 4, iter = ITER, warmup = WARMUP, data = stan_data, control = stan_control)

traceplot(fit.2, par = c('a1', 'a2'))
plot(fit.2, par = c('a1', 'a2'))
plot(fit.2, par = c('b1', 'b2'))
pairs(fit.2, par = c('a1[1]', 'a1[2]', 'a2[1]', 'a2[1]'))
pairs(fit.2, par = c('b1[1]', 'b1[2]', 'b2[1]', 'b2[1]'))
pairs(fit.2, par = c('b1[1]', 'b1[2]'))
traceplot(fit.2, par = c('b1', 'b2'))

plot(fit.2, par = c('a1'))
plot(fit.2, par = c('b1'))
plot(fit.2, par = c('a2'))
plot(fit.2, par = c('b2'))
plot(fit.2, par = c('c'))

params = summary(fit)$summary[, "mean"]
a1 = params[grep("a1\\[", names(params))]
b1 = params[grep("b1\\[", names(params))]
a2 = params[grep("a2\\[", names(params))]
b2 = params[grep("b2\\[", names(params))]
c = params[grep("c\\[", names(params))]

y_new = params[grep("y_new\\[", names(params))]
trials.table.rate = ok_trials_learning %>% group_by(username, true_sequence, cluster) %>% summarise(rateRT = b1[cluster[1]])

# calculate likelihood and compare
# plot fits for 1 and 2 exponential models 
# for(j in unique(ok_trials_learning$cluster)){
#   mydata = subset(as.data.frame(ok_trials_learning), cluster == j)
#   y = mydata$medianRT
#   x = mydata$sess_num
#   plot(x, y, pch = 20, cex = 1, main = j)
#   lines(x, a1[j]*exp(-b1[j]*x) + a2[j]*exp(-b2[j]*x) + c[j], col = "red")
# }


plot(trials.table.rate$username, trials.table.rate$rateRT, las = 2)

# trials.table.rank= trials.table.rate %>% arrange(username, true_sequence, rateRT) %>% group_by(username) %>% mutate(rankRT = percent_rank(rateRT), true_sequence = as.character(true_sequence)) %>% mutate(true_sequence = as.factor(true_sequence), sequence_length  = nchar(as.character(true_sequence)), 
# n1 = str_count(true_sequence, "1"),
# n2 = str_count(true_sequence, "2"),
# n3 = str_count(true_sequence, "3"),
# n4 = str_count(true_sequence, "4"))
# 
# plot(jitter(trials.table.rank$sequence_length), jitter(trials.table.rank$rankRT))
# 
# trials.table.ranked = trials.table.rank %>% group_by(true_sequence, sequence_length) %>% summarise(medianrank = median(rankRT), count = n(), minrank = min(rankRT), maxrank = max(rankRT)) %>% arrange(medianrank) 
# 
# plot(trials.table.ranked$medianrank, lwd = 2, type = "l")
# lines(trials.table.ranked$minrank, lty = 2)
# lines(trials.table.ranked$maxrank, lty = 2)
# 
# plot(trials.table.ranked$sequence_length, trials.table.ranked$medianrank)
# 
# lm (rankRT ~ n1 + n2 + n3 + n4, data = trials.table.rank)
# summary(lm (rankRT ~ n1 + n2 + n3 + n4, data = trials.table.rank))

```


# Evaluate the best
```{r fig.width=25, fig.asp=0.7, warning = F}

last_trials = subset(ok_unpaced_trials.clean, group == "Experimental" & trial > MINTRIALS) %>% 
  group_by(username, sess_num, followup, wave) %>% 
  dplyr::summarise(meanMT = mean(MT, na.rm = T), sdMT = sd(MT, na.rm = T))

completers = names(which(table(last_trials$username)>=36))

# select ones with all sessions
sess.first = subset(last_trials, sess_num == 1)
sess.last = subset(last_trials, sess_num == 30)

sess.diff = merge(sess.first, sess.last, by = "username", suffix = c(".first", ".last")) %>% mutate(meanMT.diff = meanMT.first - meanMT.last, meanMT.diffrel = (meanMT.first - meanMT.last)/ meanMT.first) %>% arrange(desc(meanMT.diffrel))%>% mutate(order = row_number(sess_num.first))  %>% mutate( winner = order < 4)

head(sess.diff[c("order", "username", "meanMT.diff", "meanMT.diffrel")])
last_trials = merge(last_trials, sess.diff, by = "username", all.x = T) %>% filter (username %in% completers)

plot.meanMT = ggplot(last_trials, aes(x = sess_num, y = meanMT, group = username, col = !winner)) + geom_line(size = 2) + geom_point(size = 3) + theme_lh() + xlab('Session') + ylab('Movement duration (ms)') 
print(plot.meanMT)

```
